# KqpLoad

Generates a load on the Query Processor layer and loads all {{ ydb-short-name }} cluster components. The load generated by the actor is similar to that from the [workload](../reference/ydb-cli/commands/workload/index.md) {{ ydb-short-name }} CLI subcommand, but it's generated from within the cluster. Two types of load can be run:

* **Stock**: Simulates a warehouse of an online store: creates multi-product orders, gets a list of orders per customer.
* **Key-value**: Uses the DB as a key-value store.

As a result of the test, the number of successful transactions per second, the number of transaction execution retries, and the number of errors are output.

{% include notitle [addition](../_includes/addition.md) %}

## Actor specification {#proto}

```proto
message TKqpLoad {
    message TStockWorkload {
        optional uint64 ProductCount = 1 [default = 100];
        optional uint64 Quantity = 2 [default = 1000];
        optional uint64 OrderCount = 3 [default = 100];
        optional uint64 Limit = 4 [default = 10];
        optional bool PartitionsByLoad = 5 [default = true];
    }
    message TKvWorkload {
        optional uint64 InitRowCount = 1 [default = 1000];
        optional bool PartitionsByLoad = 2 [default = true];
        optional uint64 MaxFirstKey = 3 [default = 18446744073709551615];
        optional uint64 StringLen = 4 [default = 8];
        optional uint64 ColumnsCnt = 5 [default = 2];
        optional uint64 RowsCnt = 6 [default = 1];
    }
    optional uint64 Tag = 1;
    optional uint32 DurationSeconds = 2;
    optional uint32 WindowDuration = 3;
    optional string WorkingDir = 4;
    optional uint32 NumOfSessions = 5;
    optional bool IncreaseSessions = 11;
    optional bool DeleteTableOnFinish = 6;
    optional uint32 UniformPartitionsCount = 7;
    optional uint32 WorkloadType = 8;
    oneof Workload {
        TStockWorkload Stock = 9;
        TKvWorkload Kv = 10;
    }
}
```

## Actor parameters {#options}

| Parameter | Description |
--- | ---
| `TStockWorkload[]` | [Stock load parameters](#stock-workload). |
| `TKvWorkload[]` | [Key-value load parameters](#kv-workload). |
| `Tag` | Load tag. If not specified, the tag is assigned automatically.<br>Type: `uint64`.<br>Optional. |
| `DurationSeconds` | Test duration in seconds.<br>Type: `uint32`.<br>Required. |
| `WindowDuration` | Statistics aggregation window duration.<br>Type: `uint32`.<br>Required. |
| `WorkingDir` | Path to the directory to create test tables in.<br>Type: `string`.<br>Required. |
| `NumOfSessions` | The number of parallel threads creating the load. Each thread writes data to its own session.<br>Type: `uint32`.<br>Required. |
| `DeleteTableOnFinish` | Indicates whether to delete the tables after the load stops. For example, it may be useful to Leave tables in a scenario where it takes a long time to pre-create a large table and run further (reading) tests.<br>Type: `bool`.<br>Required. |
| `UniformPartitionsCount` | The number of partitions created in test tables.<br>Type: `uint32`.<br>Required. |
| `WorkloadType` | Lets you select the type of load.<br>Key-Value:<ul><li>`0`: UpsertRandom.</li><li>`1`: InsertRandom.</li><li>`2`: SelectRandom.</li></ul>Stock:<ul><li>`0`: InsertRandomOrder.</li><li>`1`: SubmitRandomOrder.</li><li>`2`: SubmitSameOrder.</li><li>`3`: GetRandomCustomerHistory.</li><li>`4`: GetCustomerHistory.</li></ul>Type: `uint32`.<br>Required. |
| `Workload` | Possible values:<ul><li>`TStockWorkload Stock`: Stock load type.</li><li>`TKvWorkload Kv`: Key-value load type.</li></ul> |

### TStockWorkload {#stock-workload}

| Parameter | Description |
--- | ---
| `ProductCount` | The number of products.<br>Type: `uint64`.<br>Default value: `100`.<br>Optional. |
| `Quantity` | Quantity of each product in stock.<br>Type: `uint64`.<br>Default value: `1000`.<br>Optional. |
| `OrderCount` | Initial number of orders in the database.<br>Type: `uint64`.<br>Default value: `100`.<br>Optional. |
| `Limit` | Minimum number of shards for tables.<br>Type: `uint64`.<br>Default value: `10`.<br>Optional. |
| `PartitionsByLoad` | Enabling/disabling auto-sharding.<br>Type: `bool`.<br>Default value: `true`.<br>Optional. |

### TKvWorkload {#kv-workload}

| Parameter | Description |
--- | ---
| `InitRowCount` | Before a load is generated, the load actor writes the specified number of rows to the table.<br>Type: `uint64`.<br>Default value: `1000`.<br>Optional. |
| `PartitionsByLoad` | Indicates whether to add the `AUTO_PARTITIONING_BY_LOAD` attribute to the test table.<br>Type: `bool`.<br>Default value: `true`.<br>Optional. |
| `MaxFirstKey` | Limits the range of key values. Created to make sure that, under read load, random keys fall within the range of table keys.<br>Type: `uint64`.<br>Default value: `18446744073709551615`.<br>Optional. |
| `StringLen` | Length of the `value` string.<br>Type: `uint64`.<br>Default value: `8`.<br>Optional. |
| `ColumnsCnt` | Number of columns to use in the table.<br>Type: `uint64`.<br>Default value: `2` (columns for the key and value).<br>Optional. |
| `RowsCnt` | Number of rows to insert/read per SQL query<br>Type: `uint64`.<br>Default value: `1`.<br>Optional. |

## Examples {#example}

Below is the specification of an actor that runs a stock load on the `/slice/db`, database by making simple UPSERT queries of 64 threads during 30 seconds. Before this test, the necessary tables are created. After it's completed, they are deleted.

{% list tabs %}

- Embedded UI

   ```proto
   KqpLoad: {
       DurationSeconds: 30
       WindowDuration: 1
       WorkingDir: "/slice/db"
       NumOfSessions: 64
       UniformPartitionsCount: 1000
       DeleteTableOnFinish: 1
       WorkloadType: 0
       Stock: {
           ProductCount: 100
           Quantity: 1000
           OrderCount: 100
           Limit: 10
       }
   }
   ```

{% endlist %}
